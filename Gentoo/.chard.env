# Chard environmental configuration
# Temp
# <<< CHARD_ROOT_MARKER >>>
CHARD_ROOT=""
CHARD_HOME=""
CHARD_USER=""
# <<< END_CHARD_ROOT_MARKER >>>

export CHARD_ROOT
export CHARD_HOME
export CHARD_USER

ARCH=$(uname -m)
case "$ARCH" in
    x86_64) CHOST=x86_64-pc-linux-gnu ;;
    aarch64) CHOST=aarch64-unknown-linux-gnu ;;
    *) echo "Unknown architecture: $ARCH"; exit 1 ;;
esac

export CHARD_RC="$CHARD_ROOT/.chardrc"
export PORTDIR="$CHARD_ROOT/usr/portage"
export DISTDIR="$CHARD_ROOT/var/cache/distfiles"
export PKGDIR="$CHARD_ROOT/var/cache/packages"
export PORTAGE_TMPDIR="$CHARD_ROOT/var/tmp"
export SANDBOX="$CHARD_ROOT/usr/bin/sandbox"
export GIT_EXEC_PATH="$CHARD_ROOT/usr/libexec/git-core"
export PATH="$PATH:$CHARD_ROOT/usr/bin:$CHARD_ROOT/bin:$CHARD_ROOT/usr/$CHOST/gcc-bin/14:$CHARD_ROOT/usr/$CHOST/gcc-bin/15:$CHARD_ROOT/usr/local/bin"
export LD_LIBRARY_PATH="${LD_LIBRARY_PATH:-}:$CHARD_ROOT/usr/lib:$CHARD_ROOT/lib:$CHARD_ROOT/usr/lib/gcc/$CHOST/14:$CHARD_ROOT/usr/$CHOST/gcc-bin/14:$CHARD_ROOT/usr/lib/gcc/$CHOST/15:$CHARD_ROOT/usr/$CHOST/gcc-bin/15"
export PKG_CONFIG_PATH="$CHARD_ROOT/usr/lib/pkgconfig:/usr/lib64/pkgconfig:/usr/lib/pkgconfig:/usr/local/lib/pkgconfig:/usr/local/share/pkgconfig"
export MAGIC="$CHARD_ROOT/usr/share/misc/magic.mgc"
export PKG_CONFIG="$CHARD_ROOT/usr/bin/pkg-config"
export GIT_TEMPLATE_DIR="$CHARD_ROOT/usr/share/git-core/templates"
export CPPFLAGS="-I$CHARD_ROOT/usr/include"
export CC="$CHARD_ROOT/usr/bin/gcc"
export CXX="$CHARD_ROOT/usr/bin/g++"
export AR="$CHARD_ROOT/usr/bin/ar"
export NM="$CHARD_ROOT/usr/bin/gcc-nm"
export RANLIB="$CHARD_ROOT/usr/bin/gcc-ranlib"
export STRIP="$CHARD_ROOT/usr/bin/strip"
export LIBGL_ALWAYS_INDIRECT=0
export QT_QPA_PLATFORM=wayland
export SOMMELIER_DRM_DEVICE=/dev/dri/renderD128
export SOMMELIER_GLAMOR=1
export SOMMELIER_VERSION=0.20
export PULSE_SERVER=unix:/run/chrome/pulse/native
export DISPLAY=":0"
export GDK_BACKEND="wayland"
export CLUTTER_BACKEND="wayland"
export WAYLAND_DISPLAY=wayland-0
export WAYLAND_DISPLAY_LOW_DENSITY=wayland-1
export EGL_PLATFORM=wayland
export XDG_DATA_DIRS="/usr/share:$CHARD_ROOT/usr/share:$CHARD_ROOT/usr/local/share:$CHARD_ROOT/usr/share/flatpak/exports/share:$CHARD_ROOT/var/lib/flatpak/exports/share:$CHARD_ROOT/$CHARD_HOME/.local/share/flatpak/exports/share"
export EMERGE_DEFAULT_OPTS="--quiet-build=y --jobs=$(nproc)"
export CFLAGS="-O2 -pipe -I$CHARD_ROOT/usr/include -I$CHARD_ROOT/include $CFLAGS"
export CXXFLAGS="-O2 -pipe -I$CHARD_ROOT/usr/include -I$CHARD_ROOT/include $CXXFLAGS"
export LDFLAGS="-L$CHARD_ROOT/usr/lib -L$CHARD_ROOT/lib $LDFLAGS"
export ACLOCAL_PATH="$CHARD_ROOT/usr/share/aclocal:$ACLOCAL_PATH"
export M4PATH="$CHARD_ROOT/usr/share/m4:$M4PATH"
export MANPATH="$CHARD_ROOT/usr/share/man:$MANPATH"

all_perl_versions=()

if [[ ${#all_perl_versions[@]} -eq 0 ]]; then
    PERL_BASES=(
        "$CHARD_ROOT/usr/lib64/perl5"
        "$CHARD_ROOT/usr/local/lib64/perl5"
        "$CHARD_ROOT/usr/lib/perl5"
    )

    for base in "${PERL_BASES[@]}"; do
        [[ -d "$base" ]] || continue

        for dir in "$base"/*; do
            [[ -d "$dir" ]] || continue

            name=$(basename "$dir")
            ver=$(printf '%s\n' "$name" | sed -n 's/^\([0-9]\+\.[0-9]\+\).*$/\1/p')
            [[ -n "$ver" ]] && all_perl_versions+=("$ver")
        done
    done
fi

PYEXEC_BASE="$CHARD_ROOT/usr/lib/python-exec"
all_python_versions=()

if (( ${#all_python_versions[@]} == 0 )); then
    mapfile -t all_python_dirs < <(ls -1 "$PYEXEC_BASE" 2>/dev/null | grep -E '^python[0-9]+\.[0-9]+$' | sort -V)
    for d in "${all_python_dirs[@]}"; do
        ver="${d#python}"
        [[ -n "$ver" ]] && all_python_versions+=("$ver")
    done
fi

mapfile -t all_python_versions < <(printf '%s\n' "${all_python_versions[@]}" | sort -V | uniq)

latest_python=""
third_latest_python=""

if (( ${#all_python_versions[@]} > 0 )); then
    latest_python="${all_python_versions[-1]}"
fi
if (( ${#all_python_versions[@]} >= 3 )); then
    third_latest_python="${all_python_versions[-3]}"
elif (( ${#all_python_versions[@]} > 0 )); then
    third_latest_python="${all_python_versions[0]}"
fi

second_underscore="${third_latest_python//./_}"

export PYTHON_TARGETS="python${second_underscore}"
export PYTHON_SINGLE_TARGET="python${second_underscore}"

python_site_third="$CHARD_ROOT/usr/lib/python${third_latest_python}/site-packages"
python_site_latest="$CHARD_ROOT/usr/lib/python${latest_python}/site-packages"
export PYTHONPATH="${python_site_third}:${python_site_latest}${PYTHONPATH:+:$(realpath -m "$PYTHONPATH")}"

export PYEXEC_DIR="${PYEXEC_BASE}/python${third_latest_python}"
export EPYTHON="python${third_latest_python}"
export PYTHON="python${third_latest_python}"
export PORTAGE_PYTHON="python${third_latest_python}"

if command -v python3 >/dev/null && python3 --version 2>&1 | grep -q "$latest_python"; then
    alias python3="$CHARD_ROOT/usr/bin/python${third_latest_python}"
fi

# <<< END CHARD_ENV >>>
