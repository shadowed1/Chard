#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

mkdir -p ~/chard
mkdir -p ~/chard/flatpak
mkdir -p ~/chard/flatpak-deps

export PATH="$HOME/chard/usr/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/chard/usr/lib:$LD_LIBRARY_PATH"
export XDG_DATA_DIRS="$HOME/chard/usr/share:$XDG_DATA_DIRS"
export FLATPAK_USER_DIR="$HOME/chard/flatpak"

echo "${RESET}${GREEN}Run apps and games with Flatpak directly in ChromeOS without Developer mode?${RESET}"
echo "${RESET}"
echo "${YELLOW}0: Quit${RESET}"
echo "${GREEN}1: Download and install Chard to ~/chard{RESET}"
echo ""

download_and_extract()
{
    local url="$1"
    local target_dir="$2"
    local FILE SAFE_FILE
    echo "${MAGENTA}"
    echo "Downloading: $url"
    echo "${RESET}${BLUE}"
    
    if [[ -f "download" ]]; then
        FILE="download"
    else
        FILE=$(ls -t *.pkg.tar.zst 2>/dev/null | head -n 1)
    fi

    SAFE_FILE="${FILE//:/}"
    if [[ "$FILE" != "$SAFE_FILE" ]]; then
        mv "$FILE" "$SAFE_FILE"
        FILE="$SAFE_FILE"
    fi

    echo "Extracting $FILE to $target_dir"
    tar --use-compress-program=unzstd -xvf "$FILE" -C "$target_dir"


    mkdir -p "$target_dir"

    echo "${MAGENTA}Downloading: $url${RESET}"
    curl -LO "$url"

    if [[ -f "download" ]]; then
        FILE="download"
    else
        FILE=$(ls -t *.pkg.tar.zst 2>/dev/null | head -n 1)
    fi

    SAFE_FILE="${FILE//:/}"
    if [[ "$FILE" != "$SAFE_FILE" ]]; then
        mv "$FILE" "$SAFE_FILE"
        FILE="$SAFE_FILE"
    fi

    echo "${CYAN}Extracting $FILE to $target_dir${RESET}"
    unzstd "$FILE" -o "${FILE%.zst}"
    tar -xvf "${FILE%.zst}" -C "$target_dir"
    rm -f "$FILE" "${FILE%.zst}"
    rm -f "$FILE" "${FILE%.tar}"

    chmod +x "$target_dir/usr/bin/"* 2>/dev/null || true
    chmod +x "$target_dir/usr/share/"* 2>/dev/null || true

    echo "${GREEN}${SAFE_FILE} extracted to $target_dir${RESET}"

    sleep 1
}

export PATH="$HOME/opt/chard/flatpak/usr/bin:$HOME/opt/chard/flatpak-deps/usr/bin:/bin:/usr/bin:$PATH"
export LD_LIBRARY_PATH="$HOME/opt/chard/flatpak-deps/usr/lib:$LD_LIBRARY_PATH"
export XDG_RUNTIME_DIR="$HOME/.xdg-runtime-dir"
mkdir -p "$XDG_RUNTIME_DIR"
chmod 700 "$XDG_RUNTIME_DIR"

########
download_and_extract "https://archlinux.org/packages/extra/x86_64/flatpak/download" "$HOME/opt/chard/flatpak"

