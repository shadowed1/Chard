mkdir -p ~/Downloads
cd ~/

qemu-img create -f qcow2 win10.qcow2 32G

# Change 32G to larger if you have space.

mv ~/user/MyFiles/Downloads/Win10_22H2_English_x64v1.iso ~/Downloads/

qemu-system-x86_64 -cdrom ~/Downloads/Win10_22H2_English_x64v1.iso -boot d -m 2048 -hda win10.qcow2

qemu-system-x86_64 \
  -m 4G \
  -cpu qemu64 \
  -smp 4 \
  -hda win10.qcow2
  -cdrom ~/user/MyFiles/Downloads/Win10_English_x64.iso \
  -boot d \
  -name "Windows 10 VM"


#################

if [ -x "$CHARD_ROOT/usr/bin/bwrap" ]; then
            echo "Setting up privileged bwrap for Flatpak support..."
            sudo mkdir -p "$CHARD_ROOT/usr/bin"
            sudo cp -f "$CHARD_ROOT/usr/bin/bwrap" "$CHARD_ROOT/usr/bin/bwrap.elf" 2>/dev/null || \
            sudo cp -f /usr/bin/bwrap "$CHARD_ROOT/usr/bin/bwrap.elf"
            cat <<'EOF' | sudo tee "$CHARD_ROOT/usr/bin/bwrap" >/dev/null
#!/bin/bash
BWRAP_ELF="/usr/bin/bwrap.elf"

sudo chown root:root "$BWRAP_ELF" 2>/dev/null
sudo chmod u+s "$BWRAP_ELF" 2>/dev/null

"$BWRAP_ELF" "$@"

sudo chown "$(whoami)" "$BWRAP_ELF" 2>/dev/null
sudo chmod u-s "$BWRAP_ELF" 2>/dev/null
EOF

            sudo chmod +x "$CHARD_ROOT/usr/bin/bwrap"
            echo "bwrap wrapper ready inside chroot."
        else
            echo "Warning: no bwrap found in $CHARD_ROOT/usr/bin"
        fi
        
        if [ -f "/home/chronos/user/.bashrc" ]; then
            sudo mountpoint -q "$CHARD_ROOT/run/chrome" || sudo mount --bind /run/chrome "$CHARD_ROOT/run/chrome" 2>/dev/null
            sudo mountpoint -q "$CHARD_ROOT/$CHARD_HOME/user/MyFiles/Downloads" || sudo mount --bind "/home/chronos/user/MyFiles/Downloads" "$CHARD_ROOT/$CHARD_HOME/user/MyFiles/Downloads" 2>/dev/null
            sudo mount -o remount,rw,bind "$CHARD_ROOT/$CHARD_HOME/user/MyFiles/Downloads"
        else
            sudo mountpoint -q "$CHARD_ROOT/run/user/1000" || sudo mount --bind /run/user/1000 "$CHARD_ROOT/run/user/1000" 2>/dev/null
        fi
        
        sudo mountpoint -q "$CHARD_ROOT/run/dbus"   || sudo mount --bind /run/dbus "$CHARD_ROOT/run/dbus" 2>/dev/null
        sudo mountpoint -q "$CHARD_ROOT/dev/dri"    || sudo mount --bind /dev/dri "$CHARD_ROOT/dev/dri" 2>/dev/null
        sudo mountpoint -q "$CHARD_ROOT/dev/input"  || sudo mount --bind /dev/input "$CHARD_ROOT/dev/input" 2>/dev/null
        
        if [ -f "/home/chronos/user/.bashrc" ]; then
            sudo mountpoint -q "$CHARD_ROOT/run/cras" || sudo mount --bind /run/cras "$CHARD_ROOT/run/cras" 2>/dev/null
        else
            sudo mountpoint -q "$CHARD_ROOT/run/cras" || sudo mount --bind /run/user/1000/pulse "$CHARD_ROOT/run/cras" 2>/dev/null
        fi
        
        sudo chroot "$CHARD_ROOT" /bin/bash -c '
        
            mountpoint -q /proc       || mount -t proc proc /proc 2>/dev/null
            mountpoint -q /sys        || mount -t sysfs sys /sys 2>/dev/null
            mountpoint -q /dev        || mount -t devtmpfs devtmpfs /dev 2>/dev/null
            mountpoint -q /dev/shm    || mount -t tmpfs tmpfs /dev/shm 2>/dev/null
            mountpoint -q /dev/pts    || mount -t devpts devpts /dev/pts 2>/dev/null
            mountpoint -q /etc/ssl    || mount --bind /etc/ssl /etc/ssl 2>/dev/null
            mountpoint -q /run/dbus   || mount --bind /run/dbus /run/dbus 2>/dev/null
            mountpoint -q /run/chrome || mount --bind /run/chrome /run/chrome 2>/dev/null
        
            if [ -e /dev/zram0 ]; then
                mount --rbind /dev/zram0 /dev/zram0 2>/dev/null
                mount --make-rslave /dev/zram0 2>/dev/null
            fi
        
            chmod 1777 /tmp /var/tmp
        
            [ -e /dev/null    ] || mknod -m 666 /dev/null c 1 3
            [ -e /dev/tty     ] || mknod -m 666 /dev/tty c 5 0
            [ -e /dev/random  ] || mknod -m 666 /dev/random c 1 8
            [ -e /dev/urandom ] || mknod -m 666 /dev/urandom c 1 9
        
            CHARD_HOME=$(cat /.chard_home)
            HOME=$CHARD_HOME
            CHARD_USER=$(cat /.chard_user)
            USER=$CHARD_USER
            GROUP_ID=1000
            USER_ID=1000
        
            sudo -u "$USER" bash -c "
                cleanup() {
                    echo \"Logging out $USER\"
                    if [ -n \"\$PULSEAUDIO_PID\" ]; then
                        kill -9 \"\$PULSEAUDIO_PID\" 2>/dev/null
                    fi
                }
                trap cleanup EXIT INT TERM
            
                dbus-daemon --system --fork 2>/dev/null
                [ -f \"\$HOME/.bashrc\" ] && source \"\$HOME/.bashrc\" 2>/dev/null
                [ -f \"\$HOME/.smrt_env.sh\" ] && source \"\$HOME/.smrt_env.sh\"
                
                pulseaudio 2>/dev/null &
                PULSEAUDIO_PID=\"\$!\"
            
                exec chard_sommelier
            "
            umount -l /tmp/usb_mount 2>/dev/null || true
            umount -l /dev/zram0   2>/dev/null || true
            umount -l /run/chrome  2>/dev/null || true
            umount -l /run/dbus    2>/dev/null || true
            umount -l /etc/ssl     2>/dev/null || true
            umount -l /dev/pts     2>/dev/null || true
            umount -l /dev/shm     2>/dev/null || true
            umount -l /dev         2>/dev/null || true
            umount -l /sys         2>/dev/null || true
            umount -l /proc        2>/dev/null || true
        '
        
        if [ -f "/home/chronos/user/.bashrc" ]; then
            sudo umount -l "$CHARD_ROOT/run/cras" 2>/dev/null || true
        else
            sudo umount -l "$CHARD_ROOT/run/cras" 2>/dev/null || true
        fi
        
        sudo umount -l "$CHARD_ROOT/dev/input"  2>/dev/null || true
        sudo umount -l "$CHARD_ROOT/dev/dri"    2>/dev/null || true
        sudo umount -l "$CHARD_ROOT/run/dbus"   2>/dev/null || true
        
        if [ -f "/home/chronos/user/.bashrc" ]; then
            sudo umount -l "$CHARD_ROOT/$CHARD_HOME/user/MyFiles/Downloads" 2>/dev/null || true
            sudo umount -l "$CHARD_ROOT/run/chrome" 2>/dev/null || true
        else
            sudo umount -l "$CHARD_ROOT/run/user/1000" 2>/dev/null || true
        fi

        killall -9 pulseaudio 2>/dev/null
