#!/bin/bash
# ========== Begin Chard Root Logic ==========

CHARD_ROOT="$HOME/opt/chard"
CHARD_RUNTIME="$CHARD_ROOT/.xdg-runtime-dir"
CHARD_ENV="$CHARD_ROOT/.chardEnv"
CHARD_FLATPAK="$CHARD_ROOT/flatpak"
CHARD_DEPS="$CHARD_ROOT/flatpak-deps"

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

export XDG_RUNTIME_DIR="${XDG_RUNTIME_DIR:-$CHARD_RUNTIME}"
mkdir -p "$XDG_RUNTIME_DIR/doc/portal"
chmod 700 "$XDG_RUNTIME_DIR"
echo 3 > "$XDG_RUNTIME_DIR/doc/portal/version"

export USER="${USER:-$(id -un)}"

[ -f "$CHARD_ENV" ] && . "$CHARD_ENV"

echo "${MAGENTA}Aurora initializing Flatpak!${RESET}${BLUE}"

if [ ! -S "$XDG_RUNTIME_DIR/dbus-session" ]; then
  dbus-daemon --session \
    --address="unix:path=$XDG_RUNTIME_DIR/dbus-session" \
    --print-address=1 \
    --nopidfile \
    --nofork > "$XDG_RUNTIME_DIR/dbus-session.address" &
  sleep 1
fi

export DBUS_SESSION_BUS_ADDRESS=$(grep -E '^unix:' "$XDG_RUNTIME_DIR/dbus-session.address" | head -n1 | tr -d '\n')

mkdir -p "$XDG_RUNTIME_DIR" "$HOME/tmp"
chmod 700 "$XDG_RUNTIME_DIR"
export TMPDIR="$HOME/tmp"

if [ -x "$CHARD_DEPS/usr/lib/xdg-desktop-portal-gtk" ] && ! pgrep -u "$USER" -f xdg-desktop-portal-gtk > /dev/null; then
  "$CHARD_DEPS/usr/lib/xdg-desktop-portal-gtk" &
fi

if [ -x "$CHARD_DEPS/usr/lib/xdg-desktop-portal" ] && ! pgrep -u "$USER" -f xdg-desktop-portal$ > /dev/null; then
  "$CHARD_DEPS/usr/lib/xdg-desktop-portal" &
fi

flatpak --user remote-add --if-not-exists flathub https://flathub.org/repo/flathub.flatpakrepo
flatpak --user update --appstream

echo "${RESET}${CYAN}Flatpak ready!${RESET}"

# Only append wrapper functions once
if ! grep -q 'aurora() {' "$HOME/.chardbashrc"; then
cat << 'EOF' >> "$HOME/.chardbashrc"

# Flatpak --user logic
flatpak() {
  case "$1" in
    ""|--help|-h|help|--version)
      command flatpak "$@"
      ;;
    install)
      command flatpak --user "$@"
      ;;
    *)
      command flatpak --user "$@"
      ;;
  esac
}

aurora() {
  local AURORA_SCRIPT="$HOME/opt/chard/bin/aurora"

  "$AURORA_SCRIPT" "$@"

  case "$1" in
    display|cursor)
      if [ -x "$AURORA_SCRIPT" ]; then
        source <("$AURORA_SCRIPT" print-env)
      fi
      ;;
  esac
}

ln -sf "$HOME/opt/chard/bin/chard" "$HOME/opt/chard/bin/yay"
ln -sf "$HOME/opt/chard/bin/chard" "$HOME/opt/chard/bin/paru"
ln -sf "$HOME/opt/chard/bin/chard" "$HOME/opt/chard/bin/pacaur"
yay() { chard "$@"; }
paru() { chard "$@"; }

flatpak --user list --columns=application,name | tail -n +1 | sort -u > "$HOME/.chard_flatpak_cache"

EOF

  echo ""
  echo "${BOLD}${CYAN}Aurora has successfully finished setting up Flatpak! Reinitializing .chardbashrc to enable --user shortcut"
  sleep 1; echo "."; sleep 1; echo ".${RESET}"
  echo ""
  ~/opt/usr/bin/fastfetch
  echo ""
  source ~/.chardbashrc
  echo ""
  ~/opt/bin/aurora help
fi

# ========== End Chard Root Logic ==========
