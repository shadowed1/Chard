#!/bin/bash

STATE_FILE="$CHARD_ROOT/usb_mount_state"
MOUNT_POINT="/tmp/usb_mount"

if mountpoint -q "$MOUNT_POINT"; then
    echo "Unmounting temporary mount $MOUNT_POINT..."
    sudo umount "$MOUNT_POINT" || {
        echo "Failed to unmount $MOUNT_POINT"
    }
fi

if [ ! -f "$STATE_FILE" ]; then
    echo "No saved USB mount state found."
fi

echo "Restoring original USB mount state:"
while read -r PART MP FS; do
    echo "  Mounting $PART back to $MP"
    sudo mkdir -p "$MP"
    sudo mount -t "$FS" "$PART" "$MP" || {
        echo "Failed to remount $PART"
    }
done < "$STATE_FILE"
sudo rm -f "$STATE_FILE"

echo "USB restored to original mount state."
