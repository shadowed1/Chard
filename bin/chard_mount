#!/bin/bash

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

STATE_FILE="$CHARD_ROOT/tmp/usb_mount_state"
MOUNT_POINT="/tmp/usb_mount"

: > "$STATE_FILE"

USB_DEVICES=$(lsblk -dpno NAME,TRAN | awk '$2=="usb"{print $1}')

if [ -z "$USB_DEVICES" ]; then
    echo "No USB drives detected."
fi

echo "${GREEN}Detected USB drives: ${BOLD}"
echo "$USB_DEVICES"
echo "${RESET}${MAGENTA}"

for DEV in $USB_DEVICES; do
    lsblk -lnpo NAME,MOUNTPOINT "$DEV" | awk '$2 != ""' >> "$STATE_FILE"
done

if [ ! -s "$STATE_FILE" ]; then
    echo "${RESET}${MAGENTA}No mounted USB partitions found."
fi

echo "${RESET}${CYAN}Saved:"
cat "$STATE_FILE"
echo "${RESET}${BLUE}"

while read -r PART MP; do
    echo "${RESET}${BLUE}Unmounting $PART from $MP"
    sudo umount -l "$PART" 2>/dev/null
done < "$STATE_FILE"

sudo mkdir -p "$MOUNT_POINT"

while read -r PART MP; do
    BASENAME=$(basename "$PART")
    TARGET="$MOUNT_POINT/$BASENAME"
    sudo mkdir -p "$TARGET"
    echo "${RESET}${GREEN}To $TARGET ${RESET}"
    sudo mount "$PART" "$TARGET" 2>/dev/null
done < "$STATE_FILE"
