#!/bin/bash

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

STATE_FILE="$CHARD_ROOT/tmp/usb_mount_state"
MOUNT_POINT="$CHARD_ROOT/external"

: > "$STATE_FILE"

USB_DEVICES=$(lsblk -dpno NAME,TRAN | awk '$2=="usb"{print $1}')

if [ -z "$USB_DEVICES" ]; then
    echo "${RED}No USB drives detected.${RESET}"
    exit 0
fi

echo "${GREEN}Detected External drives: ${BOLD}"
echo "$USB_DEVICES"
echo "${RESET}"

for DEV in $USB_DEVICES; do
    lsblk -lnpo NAME,MOUNTPOINT "$DEV" | awk '$2 != ""' >> "$STATE_FILE"
done

if [ ! -s "$STATE_FILE" ]; then
    echo "${YELLOW}No mounted USB partitions found.${RESET}"
    exit 0
fi

echo "${RESET}${CYAN}Bind-Mounted to $CHARD_ROOT/external"
echo "${RESET}${CYAN}${BOLD}"
cat "$STATE_FILE"

sudo mkdir -p "$MOUNT_POINT"

while read -r PART MP; do
    BASENAME=$(basename "$PART")
    TARGET="$MOUNT_POINT/$BASENAME"

    sudo mkdir -p "$TARGET"
    sudo mount --bind "$MP" "$TARGET" || \
        echo "${RED}Failed to bind-mount $MP${RESET}"

done < "$STATE_FILE"
