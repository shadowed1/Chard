# Chard Startup created by Days
start on started ui
stop on stopping ui

respawn
respawn limit 5 120

env CHARD_ROOT=/usr/local/chard
env LOG_FILE=/tmp/chard_boot.log

pre-start script
    if [ ! -d "$CHARD_ROOT" ]; then
        logger -t chard "ERROR: CHARD_ROOT not found"
        stop
        exit 0
    fi
    
    if [ ! -x "$CHARD_ROOT/bin/chard" ]; then
        logger -t chard "ERROR: chard script not executable"
        stop
        exit 0
    fi
    
    if mountpoint -q "$CHARD_ROOT/proc"; then
        logger -t chard "Already mounted, skipping"
        stop
        exit 0
    fi
    
    logger -t chard "Pre-start checks passed"
end script

script
    export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
    
    echo "========== Chard Boot: $(date) ==========" >> $LOG_FILE
    
    echo "[$(date +%H:%M:%S)] Waiting for Wayland socket..." >> $LOG_FILE
    
    timeout=60
    elapsed=0
    while [ ! -S "/run/chrome/wayland-0" ] && [ $elapsed -lt $timeout ]; do
        sleep 1
        elapsed=$((elapsed + 1))
    done
    
    if [ ! -S "/run/chrome/wayland-0" ]; then
        logger -t chard "ERROR: Wayland socket not found"
        echo "[$(date +%H:%M:%S)] FAILED: Wayland socket timeout" >> $LOG_FILE
        exit 1
    fi
    
    echo "[$(date +%H:%M:%S)] Wayland socket ready after ${elapsed}s" >> $LOG_FILE
    
    echo "[$(date +%H:%M:%S)] Waiting for Chrome session..." >> $LOG_FILE
    
    timeout=30
    elapsed=0
    while ! pgrep -u chronos chrome >/dev/null 2>&1 && [ $elapsed -lt $timeout ]; do
        sleep 1
        elapsed=$((elapsed + 1))
    done
    
    if ! pgrep -u chronos chrome >/dev/null 2>&1; then
        logger -t chard "ERROR: Chrome session not found"
        echo "[$(date +%H:%M:%S)] FAILED: Chrome session timeout" >> $LOG_FILE
        exit 1
    fi
    
    echo "[$(date +%H:%M:%S)] Chrome session ready after ${elapsed}s" >> $LOG_FILE
    
    # <<< Redundant sleep >>> 
    sleep 3
    
    logger -t chard "Starting Chard environment"
    echo "[$(date +%H:%M:%S)] Launching: chard root" >> $LOG_FILE
    
    exec /bin/bash "$CHARD_ROOT/bin/chard" root < /dev/null >> $LOG_FILE 2>&1
end script

post-stop script
    logger -t chard "Chard stopped"
    echo "[$(date +%H:%M:%S)] Chard stopped" >> /tmp/chard_boot.log
end script
