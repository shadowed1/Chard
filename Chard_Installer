#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

CHARD_ROOT="/usr/local/bin/chard"
CHARD_RC="$CHARD_ROOT/.chardrc"
BUILD_DIR="$CHARD_ROOT/var/tmp/build"

echo "[+] Creating Chard directories..."
sudo mkdir -p "$CHARD_ROOT"/{etc/portage,usr/bin,usr/lib,var/tmp,var/cache/distfiles,var/cache/packages,dev,tmp}
sudo mkdir -p "$CHARD_ROOT/etc/portage/repos.conf"

echo "[+] Downloading Chard configuration files..."
sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chardrc   -o "$CHARD_ROOT/.chardrc"
sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chard.env   -o "$CHARD_ROOT/.chard.env"
sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chard.logic -o "$CHARD_ROOT/.chard.logic"

if ! grep -Fxq "<<< CHARD ENV MARKER <<<" "/home/chronos/user/.bashrc"; then
    cat >> "/home/chronos/user/.bashrc" <<EOF

# <<< CHARD ENV MARKER <<<
source "$CHARD_RC"
# <<< END CHARD ENV MARKER <<<
EOF
    echo "[+] Chard sourced to ~/.bashrc"
else
    echo "${YELLOW}[!] Chard already sourced in ~/.bashrc"
fi

ARCH=$(uname -m)
case "$ARCH" in
    x86_64) GENTOO_ARCH="amd64"; CHOST="x86_64-pc-linux-gnu";;
    aarch64) GENTOO_ARCH="arm64"; CHOST="aarch64-unknown-linux-gnu";;
    *) echo "Unknown architecture: $ARCH"; exit 1;;
esac

MAKE_CONF="$CHARD_ROOT/etc/portage/make.conf"
sudo tee "$MAKE_CONF" > /dev/null <<EOF
CHOST='${CHOST}'
ARCH='${GENTOO_ARCH}'
ACCEPT_KEYWORDS='~${GENTOO_ARCH}'
ROOT='${CHARD_ROOT}'
CFLAGS='-O2 -pipe'
CXXFLAGS='\${CFLAGS}'
PORTAGE_TMPDIR='\${ROOT}/var/tmp'
DISTDIR='\${ROOT}/var/cache/distfiles'
PKGDIR='\${ROOT}/var/cache/packages'
EOF
echo "[+] make.conf created with ARCH=${GENTOO_ARCH}"

echo "[+] Copying system files into Chard root..."
sudo tar -C / \
  --exclude=dev --exclude=proc --exclude=sys --exclude=run --exclude=tmp \
  --exclude=mnt --exclude=boot --exclude=var --exclude=home --exclude=opt \
  --exclude=usr/share --exclude=usr/local \
  --exclude=sbin \
  --exclude="$CHARD_ROOT" --exclude="$CHARD_ROOT/*" \
  -cf - bin etc lib lib64 usr \
| gzip -1 \
| sudo tar -C "$CHARD_ROOT" -xvzf -

sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/chard -o "$CHARD_ROOT/bin/chard"
sudo chmod +x "$CHARD_ROOT/bin/chard"

GCC_DIR="$CHARD_ROOT/usr/$CHOST/gcc-bin/14"

export CC="$GCC_DIR/$CHOST-gcc"
export CXX="$GCC_DIR/$CHOST-g++"
export AR="$GCC_DIR/gcc-ar"
export RANLIB="$GCC_DIR/$CHOST-gcc-ranlib"
export PATH="$PATH:$GCC_DIR:$CHARD_ROOT/usr/bin"
export CFLAGS="-I$CHARD_ROOT/usr/include -O2 -pipe"
export CXXFLAGS="$CFLAGS"
export LDFLAGS="-L$CHARD_ROOT/usr/lib"
export AWK=/usr/bin/mawk

sudo mkdir -p "$BUILD_DIR"

PACKAGES=(
    "make|4.4|tar.gz|https://ftp.gnu.org/gnu/make/make-4.4.tar.gz"
    "gmp|6.3.0|tar.xz|https://gmplib.org/download/gmp/gmp-6.3.0.tar.xz"
    "mpfr|4.2.2|tar.xz|https://www.mpfr.org/mpfr-current/mpfr-4.2.2.tar.xz"
    "binutils|2.45|tar.xz|https://ftp.gnu.org/gnu/binutils/binutils-2.45.tar.xz"
    "diffutils|3.12|tar.xz|https://ftp.gnu.org/gnu/diffutils/diffutils-3.12.tar.xz"
    "git|2.51.0|tar.gz|https://mirrors.edge.kernel.org/pub/software/scm/git/git-2.51.0.tar.gz"
)

mkdir -p "$BUILD_DIR"

for pkg in "${PACKAGES[@]}"; do
    NAME="${pkg%%|*}"
    REST="${pkg#*|}"
    VERSION="${REST%%|*}"
    REST="${REST#*|}"
    EXT="${REST%%|*}"
    URL="${REST#*|}"
    TAR_FILE="$BUILD_DIR/$NAME-$VERSION.$EXT"

    echo "[+] Downloading $NAME-$VERSION"
    sudo curl -L -o "$TAR_FILE" "$URL"

    echo "[+] Extracting $NAME-$VERSION"
    sudo tar -xf "$TAR_FILE" -C "$BUILD_DIR"
done

echo "[+] Setting up Chard Chroot..."
sudo tar -C "$CHARD_ROOT" -cf - . 2>/dev/null \
| gzip -1 \
| sudo tar -C "$CHARD_ROOT" -xvzpf -

for pkg in "${PACKAGES[@]}"; do
    NAME="${pkg%%|*}"
    REST="${pkg#*|}"
    VERSION="${REST%%|*}"

    echo "[+] Mounting Chard Chroot"
    mountpoint -q "$CHARD_ROOT/proc"    || sudo mount -t proc proc "$CHARD_ROOT/proc"
    mountpoint -q "$CHARD_ROOT/sys"     || sudo mount -t sysfs sys "$CHARD_ROOT/sys"
    mountpoint -q "$CHARD_ROOT/dev"     || sudo mount --bind /dev "$CHARD_ROOT/dev"
    mountpoint -q "$CHARD_ROOT/dev/shm" || sudo mount --bind /dev/shm "$CHARD_ROOT/dev/shm"

    echo "[+] Building $NAME-$VERSION in chroot"
    sudo chroot "$CHARD_ROOT" /bin/bash -c "

cd /var/tmp/build/$NAME-$VERSION

ARCH=\$(uname -m)
case \"\$ARCH\" in
    x86_64) CHOST=x86_64-pc-linux-gnu;;
    aarch64) CHOST=aarch64-unknown-linux-gnu;;
    *) echo 'Unknown architecture: \$ARCH'; exit 1;;
esac

GCC_DIR=/usr/\$CHOST/gcc-bin/14
export CC=\$GCC_DIR/\$CHOST-gcc
export CXX=\$GCC_DIR/\$CHOST-g++
export AR=\$GCC_DIR/gcc-ar
export RANLIB=\$GCC_DIR/\$CHOST-gcc-ranlib
export CFLAGS='-O2 -pipe -I/usr/include'
export CXXFLAGS='-O2 -pipe -I/usr/include'
export LDFLAGS='-L/usr/lib'
export PATH=/usr/\$CHOST/gcc-bin/14:/usr/bin:/bin:/usr/local/bin
export LD_LIBRARY_PATH=\"${LD_LIBRARY_PATH:+\$LD_LIBRARY_PATH:}$CHARD_ROOT/usr/lib64\"

./configure --prefix=/usr --disable-dependency-tracking
make -j\$(nproc)
make install
"

    echo "[+] Finished building $NAME-$VERSION"
    echo
done

echo "[+] Cleaning up..."
sudo umount -l "$CHARD_ROOT/dev/shm" 2>/dev/null || true
sudo umount -l "$CHARD_ROOT/dev"     2>/dev/null || true
sudo umount -l "$CHARD_ROOT/sys"     2>/dev/null || true
sudo umount -l "$CHARD_ROOT/proc"    2>/dev/null || true

sudo rm -rf "$BUILD_DIR"

sudo chown -Rf 1000:1000 \
    "$CHARD_ROOT/bin" \
    "$CHARD_ROOT/lib" \
    "$CHARD_ROOT/include" \
    "$CHARD_ROOT/share" \
    "$CHARD_ROOT/lib/python$PYTHON_VERSION" \
    "$CHARD_ROOT/var/tmp" \
    "$CHARD_ROOT/usr/portage" \
    "$CHARD_ROOT/var/cache"

echo "[+] Chard Root Environment ready to run!"
