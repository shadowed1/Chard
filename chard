#!/bin/bash
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput setaf 3)
BLUE=$(tput setaf 4)
MAGENTA=$(tput setaf 5)
CYAN=$(tput setaf 6)
BOLD=$(tput bold)
RESET=$(tput sgr0)

CHARD_ROOT="/usr/local/chard"
CHARD_RC="$CHARD_ROOT/.chardrc"

if [ -f "$CHARD_RC" ]; then
    source "$CHARD_RC"
else
    echo "ERROR: Chard environment missing. Run installer first."
    exit 1
fi

CHARD_BASH="/bin/bash"
if [ ! -x "$CHARD_BASH" ]; then
    echo "ERROR: /bin/bash not found on host system!"
    return 1
fi

ARCH=$(uname -m)
case "$ARCH" in
    x86_64) CHOST=x86_64-pc-linux-gnu ;;
    aarch64) CHOST=aarch64-unknown-linux-gnu ;;
    *) echo "Unknown architecture: $ARCH"; exit 1 ;;
esac

chard_run() {
    if [ $# -lt 1 ]; then
        echo "Usage: chard run <binary> [args...]"
        return 1
    fi

    export ROOT="$CHARD_ROOT"
    export PORTAGE_CONFIGROOT="$CHARD_ROOT"
    export PORTAGE_TMPDIR="$CHARD_ROOT/var/tmp"
    export DISTDIR="$CHARD_ROOT/var/cache/distfiles"
    export PKGDIR="$CHARD_ROOT/var/cache/packages"
    export PATH="$CHARD_ROOT/bin:$CHARD_ROOT/usr/bin:$CHARD_ROOT/bin:$CHARD_ROOT/usr/$CHOST/gcc-bin/14:$PATH"
    export LD_LIBRARY_PATH="$CHARD_ROOT/usr/lib:$CHARD_ROOT/lib:${LD_LIBRARY_PATH:-}"
    export LD_PRELOAD="$CHARD_ROOT/usr/lib64/libpython3.13.so.1.0"
    export SANDBOX="$CHARD_ROOT/usr/bin/sandbox"

    export FEATURES=$(echo "$FEATURES" | tr ' ' '\n' | grep -v '^sandbox$' | tr '\n' ' ' | sed 's/ $//')

    echo "[*] Running '$*' inside Chard environment..."
    sudo env ROOT="$ROOT" \
        PYTHONPATH="$CHARD_ROOT/usr/lib/python3.13/site-packages:$PYTHONPATH" \
        PORTAGE_CONFIGROOT="$PORTAGE_CONFIGROOT" \
        HOME="$CHARD_ROOT/root" \
        PORTAGE_TMPDIR="$PORTAGE_TMPDIR" \
        DISTDIR="$DISTDIR" \
        PKGDIR="$PKGDIR" \
        PATH="$CHARD_ROOT/usr/bin:$CHARD_ROOT/usr/lib/python-exec:$CHARD_ROOT/bin:$CHARD_ROOT/usr/$CHOST/gcc-bin/14:$PATH" \
        LD_LIBRARY_PATH="$LD_LIBRARY_PATH" \
        LD_PRELOAD="$LD_PRELOAD" \
        SANDBOX="$CHARD_ROOT/usr/bin/sandbox" \
        FEATURES="${FEATURES//sandbox/}" \
        PYTHON_TARGETS="python3_13" \
        PYTHON_SINGLE_TARGET="python3_13" \
        PYTHONPATH="$CHARD_ROOT/usr/lib/python3.13/site-packages:$PYTHONPATH" \
        BASH="$CHARD_BASH" \
        "$@"
}

cmd="$1"; shift || true

case "$cmd" in
    ""|run)
        chard_run "$@"
        ;;
    reinstall)
        echo "${RESET}${GREEN}"
        echo "[1] Quick Reinstall (Update Chard)"
        echo "${RESET}${YELLOW}[2] Full Reinstall (Run Chard Installer)"
        echo "${RESET}${RED}[q] Cancel"
        echo "${RESET}${GREEN}"
        read -p "Choose an option [1/2/q]: " choice
        case "$choice" in
            1)
                echo "${RESET}[*] Performing quick reinstall..."
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chardrc -o "$CHARD_ROOT/.chardrc"
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chard.env -o "$CHARD_ROOT/chard.env"
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chard.logic -o "$CHARD_ROOT/chard.logic"
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/chard -o "$CHARD_ROOT/bin/chard"
                sudo chmod +x "$CHARD_ROOT/bin/chard"
                echo "[*] Quick reinstall complete.${RESET}"
                ;;
            2)
                echo "${RESET}[*] Performing full reinstall..."
                bash <(curl -s "https://raw.githubusercontent.com/shadowed1/Chard/main/Chard_Installer?$(date +%s)")
                ;;
            q|Q|*)
                echo "${RESET}[*] Reinstall cancelled.${RESET}"
                ;;
        esac
        ;;
    uninstall)
        read -r -p "Are you sure you want to remove $CHARD_ROOT and chard entries from ~/.bashrc? [y/N] " ans
        if [[ "$ans" =~ ^[Yy]$ ]]; then
            echo "${RED}[*] Removing $CHARD_ROOT"
            sudo rm -rf "$CHARD_ROOT"
            sed -i '/^# <<< CHARD ENV MARKER <<</,/^# <<< END CHARD ENV MARKER <<</d' /home/chronos/user/.bashrc 2>/dev/null || true
            echo "[+] Uninstalled.${RESET}"
        else
            echo "${RED}[*] Cancelled.${RESET}"
        fi
        ;;
    categories|cat)
        PORTAGE_DIR="$CHARD_ROOT/usr/portage"
        if [ ! -d "$PORTAGE_DIR" ]; then
            echo "ERROR: Portage tree not found at $PORTAGE_DIR"
            exit 1
        fi
        echo "${GREEN}[*] Available Portage categories in $CHARD_ROOT/usr/portage:${RESET}"
        for cat in "$PORTAGE_DIR"/*/; do
            [ -d "$cat" ] || continue
            basename "$cat"
        done | sort
        ;;
    *)
        chard_run "$cmd" "$@"
        ;;
esac
