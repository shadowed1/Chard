#!/bin/bash
CHARD_ROOT="/usr/local/chard"
CHARD_RC="$CHARD_ROOT/.chardrc"

if [ -f "$CHARD_RC" ]; then
    source "$CHARD_RC"
else
    echo "ERROR: Chard environment missing. Run installer first."
    exit 1
fi

chard_emerge() {
    if [ $# -lt 1 ]; then
        echo "Usage: chard emerge <package> [options]"
        return 1
    fi
    echo "[*] Running emerge inside Chard environment..."
    sudo env \
        ROOT="$CHARD_ROOT" \
        PORTAGE_CONFIGROOT="$CHARD_ROOT" \
        PORTAGE_TMPDIR="$CHARD_ROOT/var/tmp" \
        DISTDIR="$CHARD_ROOT/var/cache/distfiles" \
        PKGDIR="$CHARD_ROOT/var/cache/packages" \
        PATH="$CHARD_ROOT/usr/bin:$CHARD_ROOT/bin:$PATH" \
        LD_LIBRARY_PATH="$CHARD_ROOT/usr/lib:$CHARD_ROOT/lib:$LD_LIBRARY_PATH" \
        "$CHARD_ROOT/usr/bin/emerge" --ask=n "$@"
}

cmd="$1"; shift || true

case "$cmd" in
    emerge)
        chard_emerge "$@"
        ;;
    run)
        if [ $# -lt 1 ]; then
            echo "Usage: chard run <binary> [args...]"
            exit 1
        fi
        "$CHARD_ROOT/usr/bin/env" bash -c \
            "PATH=$CHARD_ROOT/usr/bin:\$PATH LD_LIBRARY_PATH=$CHARD_ROOT/usr/lib:\$LD_LIBRARY_PATH $*"
        ;;
    shell)
        echo "[*] Entering sandbox shell..."
        exec bash --rcfile <(echo "source $CHARD_RC")
        ;;
    reinstall)
        echo "[*] Chard Reinstall Options:"
        echo "1) Quick reinstall (update chard scripts and environment files)"
        echo "2) Full reinstall (rerun installer)"
        echo "q) Cancel"
        read -p "Choose an option [1/2/q]: " choice

        case "$choice" in
            1)
                echo "[*] Performing quick reinstall..."
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chardrc    -o "$CHARD_ROOT/.chardrc"
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chard.env  -o "$CHARD_ROOT/chard.env"
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/.chard.logic -o "$CHARD_ROOT/chard.logic"
                sudo curl -fsSL https://raw.githubusercontent.com/shadowed1/Chard/main/chard       -o "$CHARD_ROOT/bin/chard"
                sudo chmod +x "$CHARD_ROOT/bin/chard"
                echo "[*] Quick reinstall complete."
                ;;
            2)
                echo "[*] Performing full reinstall..."
                bash <(curl -s "https://raw.githubusercontent.com/shadowed1/Chard/main/Chard_Installer?$(date +%s)")
                ;;
            q|Q|*)
                echo "[*] Reinstall cancelled."
                ;;
        esac
        ;;
    uninstall)
        echo "[*] Uninstalling Chard..."
        sudo rm -rf "$CHARD_ROOT"
        if grep -q "<<< CHARD ENV MARKER <<<" /home/chronos/user/.bashrc; then
            sed -i '/<<< CHARD ENV MARKER <<<$/,/<<< END CHARD ENV MARKER <<</d' /home/chronos/user/.bashrc
        fi
        rm -f "$CHARD_RC"
        echo "[*] Chard uninstalled."
        ;;
    *)
        echo "Usage: chard {emerge|run|shell|reinstall|uninstall} [args...]"
        ;;
esac
