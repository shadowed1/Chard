#!/bin/bash
CHARD_ROOT="/usr/local/chard"
CHARD_RC="/home/chronos/user/.chardrc"

if [ -f "$CHARD_RC" ]; then
    source "$CHARD_RC"
else
    echo "ERROR: Chard environment missing. Run installer first."
    exit 1
fi

if [ ! -x "$CHARD_ROOT/usr/bin/emerge" ]; then
    echo "[*] Bootstrapping stage3 Gentoo..."
    ARCH="$GENTOO_ARCH"

    if [ "$ARCH" = "amd64" ]; then
        FLAVOR="current-stage3-amd64-desktop"
    else
        FLAVOR="current-stage3-$ARCH"
    fi

    BASE="https://bouncer.gentoo.org/fetch/root/all/releases/$ARCH/autobuilds/$FLAVOR"
    LATEST=$(curl -fsSL "$BASE/latest-stage3-*.txt" | tail -n1 | awk '{print $1}')
    TARFILE=$(basename "$LATEST")
    TMP_TAR="$CHARD_ROOT/var/tmp/$TARFILE"

    echo "[*] Downloading $TARFILE..."
    curl -L -o "$TMP_TAR" "$BASE/$TARFILE"

    echo "[*] Extracting stage3 tarball into $CHARD_ROOT..."
    sudo tar -xJf "$TMP_TAR" -C "$CHARD_ROOT" --strip-components=1

    rm -f "$TMP_TAR"
fi

# Ensure chard environment exists
if [ -f "$CHARD_RC" ]; then
    source "$CHARD_RC"
fi

cmd="$1"; shift || true
case "$cmd" in
    install)
        echo "[*] Installing package(s): $*"
        sudo env \
            ROOT="$CHARD_ROOT" \
            PORTAGE_CONFIGROOT="$CHARD_ROOT" \
            PORTAGE_TMPDIR="$CHARD_ROOT/var/tmp" \
            DISTDIR="$CHARD_ROOT/var/cache/distfiles" \
            PKGDIR="$CHARD_ROOT/var/cache/packages" \
            PATH="$CHARD_ROOT/usr/bin:$CHARD_ROOT/bin:$PATH" \
            LD_LIBRARY_PATH="$CHARD_ROOT/usr/lib:$CHARD_ROOT/lib:$LD_LIBRARY_PATH" \
            "$CHARD_ROOT/usr/bin/emerge" --ask=n "$@"
        ;;
    run)
        if [ $# -lt 1 ]; then
            echo "Usage: chard run <binary> [args...]"
            exit 1
        fi
        "$CHARD_ROOT/usr/bin/env" bash -c "PATH=$CHARD_ROOT/usr/bin:\$PATH LD_LIBRARY_PATH=$CHARD_ROOT/usr/lib:\$LD_LIBRARY_PATH $*"
        ;;
    shell)
        echo "[*] Entering sandbox shell..."
        exec bash --rcfile <(echo "source $CHARD_RC")
        ;;
    reinstall)
        echo "[*] Reinstalling Chard..."
        bash <(curl -s "https://raw.githubusercontent.com/shadowed1/Chard/main/Chard_Installer?$(date +%s)")
        ;;
    uninstall)
        echo "[*] Uninstalling Chard..."
        # Remove chard directory
        sudo rm -rf "$CHARD_ROOT"
        # Remove marker from bashrc
        if grep -q "<<< CHARD ENV MARKER <<<" /home/chronos/user/.bashrc; then
            sed -i '/<<< CHARD ENV MARKER <<<$/,/<<< END CHARD ENV MARKER <<</d' /home/chronos/user/.bashrc
        fi
        # Remove chardrc
        rm -f "$CHARD_RC"
        echo "[*] Chard uninstalled."
        ;;
    *)
        echo "Usage: chard {install|run|shell|reinstall|uninstall} [args...]"
        ;;
esac
